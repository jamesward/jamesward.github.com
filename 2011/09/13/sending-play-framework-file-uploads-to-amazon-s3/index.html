
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Sending Play Framework File Uploads to Amazon S3 - James Ward</title>
  <meta name="author" content="James Ward">

  
  <meta name="description" content="A couple of questions [1, 2] on StackOverflow.com led me to look into how we can send file uploads in a Play Framework application to Amazon S3 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jamesward.github.com/2011/09/13/sending-play-framework-file-uploads-to-amazon-s3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="James Ward" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-784803-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">James Ward</a></h1>
  
    <h2>Heroku | Java | Scala | Cloud | Open Source | Linux</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jamesward.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/about-james-ward">About James Ward</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Sending Play Framework File Uploads to Amazon S3</h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-09-13T08:00:39-06:00" pubdate data-updated="true">Sep 13<span>th</span>, 2011</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>A couple of questions [<a href="http://stackoverflow.com/questions/7314106/handling-file-uploads-in-play-framework-on-heroku/7334400">1</a>, <a href="http://stackoverflow.com/questions/7258965/store-blob-in-heroku-or-similar-cloud-services">2</a>] on StackOverflow.com led me to look into how we can send file uploads in a Play Framework application to <a href="http://aws.amazon.com/s3/">Amazon S3</a> instead of the local disk.  For applications running on Heroku this is especially important because the local disk is not persistent.  Persistent disk storage makes it hard to scale apps.  Instead of using the file system, it&#8217;s better to use an external service which is independent of the web tier.</p>

<p>While at JavaZone I sat down with <a href="https://twitter.com/peterhilton">Peter Hilton</a> and <a href="https://twitter.com/nicolasleroux">Nicolas Leroux</a> to come up with a way to handle this.  It only took us 30 minutes to get something working - start to finish - including setup time.  This is what is so compelling about Play Framework.  I&#8217;ve built many Java web apps and it always seems like I spend too much time setting up builds, IDEs, and plumbing.  With Play we were setup and working on the actual app in less than a minute.  After getting everything working locally it took another minute to actually run it on the cloud with Heroku.  The combination of Play Framework and Heroku is a developer&#8217;s dream for fast-paced development and deployment.</p>

<p>All of the code for the sample application is on github:
<a href="https://github.com/jamesward/plays3upload">https://github.com/jamesward/plays3upload</a></p>

<p>The basics of what we did was this:</p>

<pre><code>public static void doUpload(String comment, File attachment)
{
    AWSCredentials awsCredentials = new BasicAWSCredentials(System.getenv("AWS_ACCESS_KEY"), System.getenv("AWS_SECRET_KEY"));
    AmazonS3 s3Client = new AmazonS3Client(awsCredentials);
    s3Client.createBucket(BUCKET_NAME);
    String s3Key = UUID.randomUUID().toString();
    s3Client.putObject(BUCKET_NAME, s3Key, attachment);
    Document doc = new Document(comment, s3Key, attachment.getName());
    doc.save();
    listUploads();
}
</code></pre>

<p>This uses a JPA Entity to persist the metadata about the file upload (for some reason we named it &#8216;Document&#8217;) and a reference to the file&#8217;s key in S3.  But there was a sexier way, so my co-worker <a href="https://github.com/tkral">Tim Kral</a> added a new <a href="https://github.com/jamesward/plays3upload/blob/master/app/s3/storage/S3Blob.java">S3Blob</a> type that could be used directly in the JPA Entity.  Tim also cleaned up the configuration to make it more Play Framework friendly.  So lets walk through the entire app so you can see the pieces.</p>

<p>The <a href="https://github.com/jamesward/plays3upload/blob/master/app/models/Document.java">app/models/Document.java</a> JPA Entity has three fields - the file being of type S3Blob:</p>

<pre><code>package models;

import javax.persistence.Entity;

import play.db.jpa.Model;
import s3.storage.S3Blob;

@Entity
public class Document extends Model
{
    public String fileName;
    public S3Blob file;
    public String comment;
}
</code></pre>

<p>The S3Blob is now doing all of the work to talk to the Amazon S3 APIs to persist and fetch the actual file.</p>

<p>Configuration of S3 is done by adding a plugin to the <a href="https://github.com/jamesward/plays3upload/blob/master/conf/play.plugins">conf/play.plugins</a> file:</p>

<pre><code>0: s3.storage.S3Plugin
</code></pre>

<p>The <a href="https://github.com/jamesward/plays3upload/blob/master/app/s3/storage/S3Blob.java">S3Plugin</a> handles reading the AWS credentials from the <a href="https://github.com/jamesward/plays3upload/blob/master/conf/application.conf">conf/application.conf</a> file, setting up the S3Client, and creating the S3 Bucket - if necessary.</p>

<p>In the <a href="https://github.com/jamesward/plays3upload/blob/master/conf/application.conf">conf/application.conf</a> file, environment variables are mapped to the configuration parameters in the Play application:</p>

<pre><code>aws.access.key=${AWS_ACCESS_KEY}
aws.secret.key=${AWS_SECRET_KEY}
s3.bucket=${S3_BUCKET}
</code></pre>

<p>The values could be entered into the conf file directly but I used environment variables so they would be easier to change when running on Heroku.</p>

<p>The Amazon AWS API must be added to the <a href="https://github.com/jamesward/plays3upload/blob/master/conf/dependencies.yml">conf/dependencies.yml</a> file:</p>

<pre><code>require:
    - play
    - com.amazonaws -&gt; aws-java-sdk 1.2.7
</code></pre>

<p>The sample application has a new controller in <a href="https://github.com/jamesward/plays3upload/blob/master/app/controllers/Files.java">app/controllers/Files.java</a> that can display the upload form, handle the file upload, display the list of uploads, and handle the file download:</p>

<pre><code>package controllers;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.util.List;

import models.Document;
import play.libs.MimeTypes;
import play.mvc.Controller;
import s3.storage.S3Blob;

public class Files extends Controller
{

  public static void uploadForm()
  {
    render();
  }

  public static void doUpload(File file, String comment) throws FileNotFoundException
  {
    final Document doc = new Document();
    doc.fileName = file.getName();
    doc.comment = comment;
    doc.file = new S3Blob();
    doc.file.set(new FileInputStream(file), MimeTypes.getContentType(file.getName()));

    doc.save();
    listUploads();
  }

  public static void listUploads()
  {
    List&lt;document&gt; docs = Document.findAll();
    render(docs);
  }

  public static void downloadFile(long id)
  {
    final Document doc = Document.findById(id);
    notFoundIfNull(doc);
    response.setContentTypeIfNotSet(doc.file.type());
    renderBinary(doc.file.get(), doc.fileName);
  }

}
</code></pre>

<p>The <strong>uploadForm()</strong> method just causes the <a href="https://github.com/jamesward/plays3upload/blob/master/app/views/Files/uploadForm.html">app/views/Files/uploadForm.html</a> page to be displayed.</p>

<p>The <strong>doUpload()</strong> method handles the file upload and creates a new <strong>Document</strong> object that stores the file in S3 and the comment in a database.  After storing the file and comment it runs the <strong>listUploads()</strong> method. Of-course a database must be configured in the <a href="https://github.com/jamesward/plays3upload/blob/master/conf/application.conf">conf/application.conf</a> file.  For running on Heroku the database is provided and just needs to be configured with the following values:</p>

<pre><code>db=${DATABASE_URL}
jpa.dialect=org.hibernate.dialect.PostgreSQLDialect
jpa.ddl=update
</code></pre>

<p>The <strong>listUploads()</strong> method fetches all <strong>Document</strong> objects out of the database and then displays the <a href="https://github.com/jamesward/plays3upload/blob/master/app/views/Files/listUploads.html">apps/views/files/listUploads.html</a> page.</p>

<p>If a user selects a file from the list then the <strong>downloadFile()</strong> method is called which finds the file in S3 and sends it back to the client as a binary stream.  An alternative to this would be to get the file directly from Amazon using either the <a href="file:///home/jamesw/aws-java-sdk-1.2.6/documentation/javadoc/com/amazonaws/services/s3/AmazonS3Client.html#generatePresignedUrl(java.lang.String,%20java.lang.String,%20java.util.Date">S3 generatePresignedUrl()</a>) method or via <a href="http://aws.amazon.com/cloudfront/">CloudFront</a>.</p>

<p>Finally in the <a href="https://github.com/jamesward/plays3upload/blob/master/conf/routes">conf/routes</a> file, requests to &#8220;/&#8221; have been mapped to the <strong>Files.uploadForm()</strong> method:</p>

<pre><code>GET     /                                       Files.uploadForm
</code></pre>

<p>That&#8217;s it!  Now we have an easy way to persist file uploads in an external system!</p>

<h2>Running the Play! app on Heroku</h2>

<p>If you&#8217;d like to run this example on Heroku, here is what you need to do:</p>

<p>Install the heroku command line client on <a href="http://toolbelt.herokuapp.com/linux/readme">Linux</a>, <a href="http://toolbelt.herokuapp.com/osx/download">Mac</a>, or <a href="http://toolbelt.herokuapp.com/windows/download">Windows</a>.</p>

<p>Login to Heroku via the command line:</p>

<pre><code>heroku auth:login
</code></pre>

<p>Clone the git repo:</p>

<pre><code>git clone git@github.com:jamesward/plays3upload.git
</code></pre>

<p>Move to the project dir:</p>

<pre><code>cd plays3upload
</code></pre>

<p>Create the app on Heroku:</p>

<pre><code>heroku create -s cedar
</code></pre>

<p>Set the AWS environment vars on Heroku:</p>

<pre><code>heroku config:add AWS_ACCESS_KEY="YOUR_AWS_ACCESS_KEY" AWS_SECRET_KEY="YOUR_AWS_SECRET_KEY" S3_BUCKET="AN_AWS_UNIQUE_BUCKET_ID"
</code></pre>

<p>Upload the app to Heroku:</p>

<pre><code>git push heroku master
</code></pre>

<p>Open the app in the browser:</p>

<pre><code>heroku open
</code></pre>

<p>Let me know if you have any questions or problems.  And thanks to Peter, Nicolas, and Tim for helping with this!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">James Ward</span></span>

      








  


<time datetime="2011-09-13T08:00:39-06:00" pubdate data-updated="true">Sep 13<span>th</span>, 2011</time>
      

<span class="categories">
  
    <a class='category' href='/categories/heroku/'>Heroku</a>, <a class='category' href='/categories/java/'>Java</a>, <a class='category' href='/categories/play-framework/'>Play Framework</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://jamesward.github.com/2011/09/13/sending-play-framework-file-uploads-to-amazon-s3/" data-via="_JamesWard" data-counturl="http://jamesward.github.com/2011/09/13/sending-play-framework-file-uploads-to-amazon-s3/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2011/08/31/java-and-play-framework-on-the-cloud-at-javazone/" title="Previous Post: Java and Play Framework on the Cloud at JavaZone">&laquo; Java and Play Framework on the Cloud at JavaZone</a>
      
      
        <a class="basic-alignment right" href="/2011/09/14/flex-aop-and-puzzlers-at-flash-camp-italy/" title="next Post: Flex AOP and Puzzlers at Flash Camp Italy">Flex AOP and Puzzlers at Flash Camp Italy &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    
<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("_JamesWard", 5, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/_JamesWard" class="twitter-follow-button" data-show-count="false">Follow @_JamesWard</a>
  
</section>


<section class="googleplus">
  <h1>
    <a href="https://plus.google.com/101156657838073927919?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



<section>
  <h1>Github Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/jamesward">@jamesward</a> on Github
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jamesward',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/12/12/heroku-jug-tour-boulder-phoenix-portland/">Heroku JUG Tour: Boulder, Phoenix, & Portland</a>
      </li>
    
      <li class="post">
        <a href="/2011/12/11/tutorial-play-framework-jpa-json-jquery-heroku/">Tutorial: Play Framework, JPA, JSON, jQuery, & Heroku</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/30/using-mongodb-for-a-java-web-apps-httpsession/">Using MongoDB for a Java Web App's HttpSession</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/30/heroku-java-user-group-tour-columbus-and-orange-county/">Heroku Java User Group Tour: Columbus and Orange County</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/29/heroku-preso-from-devoxx-2011/">Heroku Preso from Devoxx 2011</a>
      </li>
    
  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2011 - James Ward -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jamesward';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
